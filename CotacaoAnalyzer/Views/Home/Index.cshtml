@* @{
    ViewData["Title"] = "Home Page";
}

<div class="text-center">
    <h1 class="display-4 mb-4">Welcome</h1>

    <button id="btnProdutos" class="btn btn-primary mb-4">
        <i class="bi bi-list-ul me-2"></i> Buscar Produtos
    </button>

    <div id="tabela-container" class="table-responsive d-none">
        <table id="tabela-produtos" class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Mensagem de erro -->
    <div id="mensagem-erro" class="alert alert-danger d-none mt-3"></div>
</div>

@section Scripts {
    <script>
        // ===== FUNÇÕES PRINCIPAIS ===== //

        async function carregarProdutos() {
            const response = await fetch('/api/v1/produtoapi/Produtos');
            if (!response.ok) throw new Error(`Erro ${response.status}: ${response.statusText}`);
            return await response.json();
        }

        function popularTabela(produtos) {
            const tbody = document.querySelector('#tabela-produtos tbody');
            tbody.innerHTML = produtos.map(criarLinhaProduto).join('');
        }

        function criarLinhaProduto(produto) {
            return `
                <tr>
                    <td>${produto.codigoProduto}</td>
                    <td>${produto.nomeProduto}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-2 btn-editar" data-id="${produto.codigoProduto}">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-excluir" data-id="${produto.codigoProduto}">
                            <i class="bi bi-trash"></i> Excluir
                        </button>
                    </td>
                </tr>
            `;
        }

        // ===== CONTROLE DE ESTADO/UI ===== //

        function toggleUI(loading = false) {
            const btn = document.getElementById('btnProdutos');
            btn.disabled = loading;
            btn.innerHTML = loading
                ? '<span class="spinner-border spinner-border-sm"></span> Carregando...'
                : '<i class="bi bi-list-ul me-2"></i> Buscar Produtos';
        }

        function mostrarErro(mensagem) {
            const mensagemErro = document.getElementById('mensagem-erro');
            mensagemErro.textContent = mensagem;
            mensagemErro.classList.remove('d-none');
        }

        // ===== EVENTOS ===== //

        document.getElementById('btnProdutos').addEventListener('click', async () => {
            const tabelaContainer = document.getElementById('tabela-container');

            toggleUI(true);
            document.getElementById('mensagem-erro').classList.add('d-none');

            try {
                const produtos = await carregarProdutos();
                popularTabela(produtos);
                tabelaContainer.classList.remove('d-none');
            } catch (error) {
                mostrarErro(`Falha ao carregar produtos: ${error.message}`);
            } finally {
                toggleUI(false);
            }
        });
    </script>
} *@